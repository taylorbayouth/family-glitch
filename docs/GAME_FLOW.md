# Game Flow Documentation

This document describes the current gameplay flow implemented in `/play`.

## Overview

Family Glitch is pass-and-play:
- Questions are preloaded during the pass screen.
- A player taps a full-screen button to reveal their turn.
- The AI uses input templates in Act 1 and mini-games in Act 2+ (per prompt rules).
- Commentary is shown after each turn with a manual "Pass to {next}" button.
- End-game results are generated by `/api/announcer`.

## Flow Diagram

```
Setup (/setup)
  -> Pass Screen (preload AI question)
    -> Question Template OR Mini-Game
      -> AI Commentary
        -> Next Player (loop)
          -> EndGameResults (when isGameComplete() is true)
```

## Key Files

- `app/setup/page.tsx` (player roster)
- `app/play/page.tsx` (game controller)
- `components/PassToPlayerScreen.tsx`
- `components/input-templates/*`
- `components/mini-games/*`
- `components/GameHeader.tsx` (leaderboard + progress)
- `components/EndGameResults.tsx`

## Pass Screen

- Component: `PassToPlayerScreen`
- Shows current player name and role.
- Uses a large button to unlock (no slide interaction).
- `SlideToUnlock` exists but is not used in `/play`.

## Question Preloading

`/play` calls `loadQuestion()` while the pass screen is visible. The AI response is parsed into a template config before the player unlocks the screen.

Key behavior in `loadQuestion()`:
- Calls `/api/chat` with `toolChoice: 'required'`
- Parses `response.text` as JSON
- If the template type is a mini-game, it loads the mini-game config
- Otherwise, it creates a `Turn` via `addTurn()` and stores `currentTemplate`

## Question Templates

When a standard template is returned:

- `TemplateRenderer` renders the template component.
- `tpl_player_selector` is injected with `players` and `currentPlayerId` in `/play`.
- On submit, `/play` calls `completeTurn()` and requests AI commentary (`toolChoice: 'none'`).

## Mini-Games

When a mini-game template is returned:

- `/play` uses the registry in `lib/mini-games/`.
- The mini-game UI handles its own AI calls and scoring.
- On completion, the mini-game returns a `MiniGameResult`.

Note: `/play` currently does not create a `Turn` entry for mini-game rounds.

## Commentary Phase

- After a response or mini-game, `/play` shows a commentary screen.
- Player taps "Pass to {next}" to advance.

## End Game Results

- `/play` calls `isGameComplete()` from `useGameStore()`.
- `EndGameResults` fetches `/api/announcer` using current `players`, `turns`, `scores`, and `settings`.
- Rankings and blurbs are revealed with staged animations.

## State Summary

### Player Store

- localStorage key: `family-glitch-players`
- Stores roster data across games

### Game Store

- localStorage key: `family-glitch-game`
- Stores turns, scores, and game status
- Progress helpers:
  - `getTotalRounds()` uses `calculateTotalRounds(players.length)`
  - `getCurrentRound()` counts completed turns
  - `getCurrentAct()` maps rounds to Act I/II/III

## Avatars

Avatar images are PNGs in `public/avatars/` (1.png to 14.png). Both setup and in-game UIs use these images.
